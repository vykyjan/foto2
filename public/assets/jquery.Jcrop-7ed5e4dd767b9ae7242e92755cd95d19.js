/**
 * jquery.Jcrop.js v0.9.9
 * jQuery Image Cropping Plugin
 * @author Kelly Hallman <khallman@gmail.com>
 * Copyright (c) 2008-2011 Kelly Hallman - released under MIT License {{{
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 *
 * }}}
 */
(function(a){a.Jcrop=function(b,c){function i(a){return parseInt(a,10)+"px"}function j(a){return parseInt(a,10)+"%"}function k(a){return d.baseClass+"-"+a}function l(){return a.fx.step.hasOwnProperty("backgroundColor")}function m(b){var c=a(b).offset();return[c.left,c.top]}function n(a){return[a.pageX-e[0],a.pageY-e[1]]}function o(b){typeof b!="object"&&(b={}),d=a.extend(d,b),typeof d.onChange!="function"&&(d.onChange=function(){}),typeof d.onSelect!="function"&&(d.onSelect=function(){}),typeof d.onRelease!="function"&&(d.onRelease=function(){})}function p(a){a!==f&&(db.setCursor(a),f=a)}function q(a,b){e=m(G),db.setCursor(a==="move"?a:a+"-resize");if(a==="move")return db.activateHandlers(s(b),A);var c=bb.getFixed(),d=t(a),f=bb.getCorner(t(d));bb.setPressed(bb.getCorner(d)),bb.setCurrent(f),db.activateHandlers(r(a,c),A)}function r(a,b){return function(c){if(!d.aspectRatio)switch(a){case"e":c[1]=b.y2;break;case"w":c[1]=b.y2;break;case"n":c[0]=b.x2;break;case"s":c[0]=b.x2}else switch(a){case"e":c[1]=b.y+1;break;case"w":c[1]=b.y+1;break;case"n":c[0]=b.x+1;break;case"s":c[0]=b.x+1}bb.setCurrent(c),cb.update()}}function s(a){var b=a;return eb.watchKeys(),function(a){bb.moveOffset([a[0]-b[0],a[1]-b[1]]),b=a,cb.update()}}function t(a){switch(a){case"n":return"sw";case"s":return"nw";case"e":return"nw";case"w":return"ne";case"ne":return"sw";case"nw":return"se";case"se":return"nw";case"sw":return"ne"}}function u(a){return function(b){return d.disabled?!1:a==="move"&&!d.allowMove?!1:(Y=!0,q(a,n(b)),b.stopPropagation(),b.preventDefault(),!1)}}function v(a,b,c){var d=a.width(),e=a.height();d>b&&b>0&&(d=b,e=b/a.width()*a.height()),e>c&&c>0&&(e=c,d=c/a.height()*a.width()),V=a.width()/d,W=a.height()/e,a.width(d).height(e)}function z(a){return{x:parseInt(a.x*V,10),y:parseInt(a.y*W,10),x2:parseInt(a.x2*V,10),y2:parseInt(a.y2*W,10),w:parseInt(a.w*V,10),h:parseInt(a.h*W,10)}}function A(a){var b=bb.getFixed();b.w>d.minSelect[0]&&b.h>d.minSelect[1]?(cb.enableHandles(),cb.done()):cb.release(),db.setCursor(d.allowSelect?"crosshair":"default")}function B(a){if(d.disabled)return!1;if(!d.allowSelect)return!1;Y=!0,e=m(G),cb.disableHandles(),p("crosshair");var b=n(a);return bb.setPressed(b),cb.update(),db.activateHandlers(C,A),eb.watchKeys(),a.stopPropagation(),a.preventDefault(),!1}function C(a){bb.setCurrent(a),cb.update()}function D(){var b=a("<div></div>").addClass(k("tracker"));return a.browser.msie&&b.css({opacity:0,backgroundColor:"white"}),b}function fb(a){J.removeClass().addClass(k("holder")).addClass(a)}function gb(a,b){function t(){window.setTimeout(u,l)}var c=parseInt(a[0],10)/V,e=parseInt(a[1],10)/W,f=parseInt(a[2],10)/V,g=parseInt(a[3],10)/W;if(Z)return;var h=bb.flipCoords(c,e,f,g),i=bb.getFixed(),j=[i.x,i.y,i.x2,i.y2],k=j,l=d.animationDelay,m=h[0]-j[0],n=h[1]-j[1],o=h[2]-j[2],p=h[3]-j[3],q=0,r=d.swingSpeed;x=k[0],y=k[1],f=k[2],g=k[3],cb.animMode(!0);var s,u=function(){return function(){q+=(100-q)/r,k[0]=x+q/100*m,k[1]=y+q/100*n,k[2]=f+q/100*o,k[3]=g+q/100*p,q>=99.8&&(q=100),q<100?(ib(k),t()):(cb.done(),typeof b=="function"&&b.call(sb))}}();t()}function hb(a){ib([parseInt(a[0],10)/V,parseInt(a[1],10)/W,parseInt(a[2],10)/V,parseInt(a[3],10)/W])}function ib(a){bb.setPressed([a[0],a[1]]),bb.setCurrent([a[2],a[3]]),cb.update()}function jb(){return z(bb.getFixed())}function kb(){return bb.getFixed()}function lb(a){o(a),rb()}function mb(){d.disabled=!0,cb.disableHandles(),cb.setCursor("default"),db.setCursor("default")}function nb(){d.disabled=!1,rb()}function ob(){cb.done(),db.activateHandlers(null,null)}function pb(){J.remove(),F.show(),a(b).removeData("Jcrop")}function qb(a,b){cb.release(),mb();var c=new Image;c.onload=function(){var e=c.width,f=c.height,g=d.boxWidth,h=d.boxHeight;G.width(e).height(f),G.attr("src",a),K.attr("src",a),v(G,g,h),H=G.width(),I=G.height(),K.width(H).height(I),P.width(H+O*2).height(I+O*2),J.width(H).height(I),nb(),typeof b=="function"&&b.call(sb)},c.src=a}function rb(a){d.allowResize?a?cb.enableOnly():cb.enableHandles():cb.disableHandles(),db.setCursor(d.allowSelect?"crosshair":"default"),cb.setCursor(d.allowMove?"move":"default"),d.hasOwnProperty("setSelect")&&(hb(d.setSelect),cb.done(),delete d.setSelect),d.hasOwnProperty("trueSize")&&(V=d.trueSize[0]/H,W=d.trueSize[1]/I),d.hasOwnProperty("bgColor")&&(l()&&d.fadeTime?J.animate({backgroundColor:d.bgColor},{queue:!1,duration:d.fadeTime}):J.css("backgroundColor",d.bgColor),delete d.bgColor),d.hasOwnProperty("bgOpacity")&&(Q=d.bgOpacity,cb.isAwake()&&(d.fadeTime?G.fadeTo(d.fadeTime,Q):J.css("opacity",d.opacity)),delete d.bgOpacity),R=d.maxSize[0]||0,S=d.maxSize[1]||0,T=d.minSize[0]||0,U=d.minSize[1]||0,d.hasOwnProperty("outerImage")&&(G.attr("src",d.outerImage),delete d.outerImage),cb.refresh()}var d=a.extend({},a.Jcrop.defaults),e,f,g=!1;a.browser.msie&&a.browser.version.split(".")[0]==="6"&&(g=!0),typeof b!="object"&&(b=a(b)[0]),typeof c!="object"&&(c={}),o(c);var E={border:"none",margin:0,padding:0,position:"absolute"},F=a(b),G=F.clone().removeAttr("id").css(E);G.width(F.width()),G.height(F.height()),F.after(G).hide(),v(G,d.boxWidth,d.boxHeight);var H=G.width(),I=G.height(),J=a("<div />").width(H).height(I).addClass(k("holder")).css({position:"relative",backgroundColor:d.bgColor}).insertAfter(F).append(G);delete d.bgColor,d.addClass&&J.addClass(d.addClass);var K=a("<img />").attr("src",G.attr("src")).css(E).width(H).height(I),L=a("<div />").width(j(100)).height(j(100)).css({zIndex:310,position:"absolute",overflow:"hidden"}).append(K),M=a("<div />").width(j(100)).height(j(100)).css("zIndex",320),N=a("<div />").css({position:"absolute",zIndex:300}).insertBefore(G).append(L,M);g&&N.css({overflowY:"hidden"});var O=d.boundary,P=D().width(H+O*2).height(I+O*2).css({position:"absolute",top:i(-O),left:i(-O),zIndex:290}).mousedown(B),Q=d.bgOpacity,R,S,T,U,V,W,X=!0,Y,Z,_;e=m(G);var ab=function(){function a(){var a={},b=["touchstart","touchmove","touchend"],c=document.createElement("div"),d;try{for(d=0;d<b.length;d++){var e=b[d];e="on"+e;var f=e in c;f||(c.setAttribute(e,"return;"),f=typeof c[e]=="function"),a[b[d]]=f}return a.touchstart&&a.touchend&&a.touchmove}catch(g){return!1}}function b(){return d.touchSupport===!0||d.touchSupport===!1?d.touchSupport:a()}return{createDragger:function(a){return function(b){return b.pageX=b.originalEvent.changedTouches[0].pageX,b.pageY=b.originalEvent.changedTouches[0].pageY,d.disabled?!1:a==="move"&&!d.allowMove?!1:(Y=!0,q(a,n(b)),b.stopPropagation(),b.preventDefault(),!1)}},newSelection:function(a){return a.pageX=a.originalEvent.changedTouches[0].pageX,a.pageY=a.originalEvent.changedTouches[0].pageY,B(a)},isSupported:a,support:b()}}(),bb=function(){function i(d){d=o(d),c=a=d[0],e=b=d[1]}function j(a){a=o(a),f=a[0]-c,g=a[1]-e,c=a[0],e=a[1]}function k(){return[f,g]}function l(d){var f=d[0],g=d[1];0>a+f&&(f-=f+a),0>b+g&&(g-=g+b),I<e+g&&(g+=I-(e+g)),H<c+f&&(f+=H-(c+f)),a+=f,c+=f,b+=g,e+=g}function m(a){var b=n();switch(a){case"ne":return[b.x2,b.y];case"nw":return[b.x,b.y];case"se":return[b.x2,b.y2];case"sw":return[b.x,b.y2]}}function n(){if(!d.aspectRatio)return q();var f=d.aspectRatio,g=d.minSize[0]/V,i=d.maxSize[0]/V,j=d.maxSize[1]/W,k=c-a,l=e-b,m=Math.abs(k),n=Math.abs(l),o=m/n,s,t;return i===0&&(i=H*10),j===0&&(j=I*10),o<f?(t=e,w=n*f,s=k<0?a-w:w+a,s<0?(s=0,h=Math.abs((s-a)/f),t=l<0?b-h:h+b):s>H&&(s=H,h=Math.abs((s-a)/f),t=l<0?b-h:h+b)):(s=c,h=m/f,t=l<0?b-h:b+h,t<0?(t=0,w=Math.abs((t-b)*f),s=k<0?a-w:w+a):t>I&&(t=I,w=Math.abs(t-b)*f,s=k<0?a-w:w+a)),s>a?(s-a<g?s=a+g:s-a>i&&(s=a+i),t>b?t=b+(s-a)/f:t=b-(s-a)/f):s<a&&(a-s<g?s=a-g:a-s>i&&(s=a-i),t>b?t=b+(a-s)/f:t=b-(a-s)/f),s<0?(a-=s,s=0):s>H&&(a-=s-H,s=H),t<0?(b-=t,t=0):t>I&&(b-=t-I,t=I),r(p(a,b,s,t))}function o(a){return a[0]<0&&(a[0]=0),a[1]<0&&(a[1]=0),a[0]>H&&(a[0]=H),a[1]>I&&(a[1]=I),[a[0],a[1]]}function p(a,b,c,d){var e=a,f=c,g=b,h=d;return c<a&&(e=c,f=a),d<b&&(g=d,h=b),[Math.round(e),Math.round(g),Math.round(f),Math.round(h)]}function q(){var d=c-a,f=e-b,g;return R&&Math.abs(d)>R&&(c=d>0?a+R:a-R),S&&Math.abs(f)>S&&(e=f>0?b+S:b-S),U/W&&Math.abs(f)<U/W&&(e=f>0?b+U/W:b-U/W),T/V&&Math.abs(d)<T/V&&(c=d>0?a+T/V:a-T/V),a<0&&(c-=a,a-=a),b<0&&(e-=b,b-=b),c<0&&(a-=c,c-=c),e<0&&(b-=e,e-=e),c>H&&(g=c-H,a-=g,c-=g),e>I&&(g=e-I,b-=g,e-=g),a>H&&(g=a-I,e-=g,b-=g),b>I&&(g=b-I,e-=g,b-=g),r(p(a,b,c,e))}function r(a){return{x:a[0],y:a[1],x2:a[2],y2:a[3],w:a[2]-a[0],h:a[3]-a[1]}}var a=0,b=0,c=0,e=0,f,g;return{flipCoords:p,setPressed:i,setCurrent:j,getOffset:k,moveOffset:l,getCorner:m,getFixed:n}}(),cb=function(){function l(b){var c=a("<div />").css({position:"absolute",opacity:d.borderOpacity}).addClass(k(b));return L.append(c),c}function m(b,c){var d=a("<div />").mousedown(u(b)).css({cursor:b+"-resize",position:"absolute",zIndex:c});return ab.support&&d.bind("touchstart",ab.createDragger(b)),M.append(d),d}function n(a){return m(a,c++).css({top:i(-h+1),left:i(-h+1),opacity:d.handleOpacity}).addClass(k("handle"))}function o(a){var b=d.handleSize,e=b,f=b,g=h,k=h;switch(a){case"n":case"s":f=j(100);break;case"e":case"w":e=j(100)}return m(a,c++).width(f).height(e).css({top:i(-g+1),left:i(-k+1)})}function p(a){var b;for(b=0;b<a.length;b++)f[a[b]]=n(a[b])}function q(a){var b=Math.round(a.h/2-h),c=Math.round(a.w/2-h),d=-h+1,e=-h+1,g=a.w-h,j=a.h-h,k,l;f.e&&(f.e.css({top:i(b),left:i(g)}),f.w.css({top:i(b)}),f.s.css({top:i(j),left:i(c)}),f.n.css({left:i(c)})),f.ne&&(f.ne.css({left:i(g)}),f.se.css({top:i(j),left:i(g)}),f.sw.css({top:i(j)})),f.b&&(f.b.css({top:i(j)}),f.r.css({left:i(g)}))}function r(a,b){K.css({top:i(-b),left:i(-a)}),N.css({top:i(b),left:i(a)})}function s(a,b){N.width(a).height(b)}function t(){var a=bb.getFixed();bb.setPressed([a.x,a.y]),bb.setCurrent([a.x2,a.y2]),v()}function v(){if(b)return w()}function w(){var a=bb.getFixed();s(a.w,a.h),r(a.x,a.y),g&&q(a),b||x(),d.onChange.call(sb,z(a))}function x(){N.show(),d.bgFade?G.fadeTo(d.fadeTime,Q):G.css("opacity",Q),b=!0}function y(){C(),N.hide(),d.bgFade?G.fadeTo(d.fadeTime,1):G.css("opacity",1),b=!1,d.onRelease.call(sb)}function A(){g&&(q(bb.getFixed()),M.show())}function B(){g=!0;if(d.allowResize)return q(bb.getFixed()),M.show(),!0}function C(){g=!1,M.hide()}function E(a){Z===a?C():B()}function F(){E(!1),t()}var b,c=370,e={},f={},g=!1,h=d.handleOffset;d.drawBorders&&(e={top:l("hline"),bottom:l("hline bottom"),left:l("vline"),right:l("vline right")}),d.dragEdges&&(f.t=o("n"),f.b=o("s"),f.r=o("e"),f.l=o("w")),d.sideHandles&&p(["n","s","e","w"]),d.cornerHandles&&p(["sw","nw","ne","se"]);var H=D().mousedown(u("move")).css({cursor:"move",position:"absolute",zIndex:360});return ab.support&&H.bind("touchstart.jcrop",ab.createDragger("move")),L.append(H),C(),{updateVisible:v,update:w,release:y,refresh:t,isAwake:function(){return b},setCursor:function(a){H.css("cursor",a)},enableHandles:B,enableOnly:function(){g=!0},showHandles:A,disableHandles:C,animMode:E,done:F}}(),db=function(){function f(){P.css({zIndex:450}),e&&a(document).bind("mousemove",h).bind("mouseup",i)}function g(){P.css({zIndex:290}),e&&a(document).unbind("mousemove",h).unbind("mouseup",i)}function h(a){return b(n(a)),!1}function i(a){return a.preventDefault(),a.stopPropagation(),Y&&(Y=!1,c(n(a)),cb.isAwake()&&d.onSelect.call(sb,z(bb.getFixed())),g(),b=function(){},c=function(){}),!1}function j(a,d){return Y=!0,b=a,c=d,f(),!1}function k(a){return a.pageX=a.originalEvent.changedTouches[0].pageX,a.pageY=a.originalEvent.changedTouches[0].pageY,h(a)}function l(a){return a.pageX=a.originalEvent.changedTouches[0].pageX,a.pageY=a.originalEvent.changedTouches[0].pageY,i(a)}function m(a){P.css("cursor",a)}var b=function(){},c=function(){},e=d.trackDocument;return ab.support&&a(document).bind("touchmove",k).bind("touchend",l),e||P.mousemove(h).mouseup(i).mouseout(i),G.before(P),{activateHandlers:j,setCursor:m}}(),eb=function(){function e(){d.keySupport&&(b.show(),b.focus())}function f(a){b.hide()}function h(a,b,c){d.allowMove&&(bb.moveOffset([b,c]),cb.updateVisible()),a.preventDefault(),a.stopPropagation()}function i(a){if(a.ctrlKey)return!0;_=a.shiftKey?!0:!1;var b=_?10:1;switch(a.keyCode){case 37:h(a,-b,0);break;case 39:h(a,b,0);break;case 38:h(a,0,-b);break;case 40:h(a,0,b);break;case 27:cb.release();break;case 9:return!0}return!1}var b=a('<input type="radio" />').css({position:"fixed",left:"-120px",width:"12px"}),c=a("<div />").css({position:"absolute",overflow:"hidden"}).append(b);return d.keySupport&&(b.keydown(i).blur(f),g||!d.fixedSupport?(b.css({position:"absolute",left:"-20px"}),c.append(b).insertBefore(G)):b.insertBefore(G)),{watchKeys:e}}();ab.support&&P.bind("touchstart",ab.newSelection),M.hide(),rb(!0);var sb={setImage:qb,animateTo:gb,setSelect:hb,setOptions:lb,tellSelect:jb,tellScaled:kb,setClass:fb,disable:mb,enable:nb,cancel:ob,release:cb.release,destroy:pb,focus:eb.watchKeys,getBounds:function(){return[H*V,I*W]},getWidgetSize:function(){return[H,I]},getScaleFactor:function(){return[V,W]},ui:{holder:J,selection:N}};return a.browser.msie&&J.bind("selectstart",function(){return!1}),F.data("Jcrop",sb),sb},a.fn.Jcrop=function(b,c){function d(d){var e=typeof b=="object"?b:{},f=e.useImg||d.src,g=new Image;g.onload=function(){function b(){var b=a.Jcrop(d,e);typeof c=="function"&&c.call(b)}function f(){!g.width||!g.height?window.setTimeout(f,50):b()}window.setTimeout(f,50)},g.src=f}return this.each(function(){if(a(this).data("Jcrop")){if(b==="api")return a(this).data("Jcrop");a(this).data("Jcrop").setOptions(b)}else d(this)}),this},a.Jcrop.defaults={allowSelect:!0,allowMove:!0,allowResize:!0,trackDocument:!0,baseClass:"jcrop",addClass:null,bgColor:"black",bgOpacity:.6,bgFade:!1,borderOpacity:.4,handleOpacity:.5,handleSize:9,handleOffset:5,aspectRatio:0,keySupport:!0,cornerHandles:!0,sideHandles:!0,drawBorders:!0,dragEdges:!0,fixedSupport:!0,touchSupport:null,boxWidth:0,boxHeight:0,boundary:2,fadeTime:400,animationDelay:20,swingSpeed:3,minSelect:[0,0],maxSize:[0,0],minSize:[0,0],onChange:function(){},onSelect:function(){},onRelease:function(){}}})(jQuery);